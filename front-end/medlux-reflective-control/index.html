<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="app-version" content="1.0.0" />
  <title>MEDLUX Reflective Control</title>
  <link rel="stylesheet" href="../medlux-control/styles.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js" defer></script>
  <script type="module" src="./app.js" defer></script>
</head>
<body>
  <header class="app-topbar">
    <div class="app-topbar__brand">
      <img class="app-topbar__logo" src="../assets/img/medlux-logo.png" alt="Logo MEDLUX" />
      <p class="app-topbar__title">MEDLUX Reflective Control</p>
    </div>
    <div class="badge">Medições de campo</div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="module-header">
        <div class="brand">
          <h1><span class="dot"></span>MEDLUX Reflective Control</h1>
          <p>Registro de medições de retrorrefletância para equipamentos vinculados.</p>
        </div>
        <div class="header-actions">
          <div class="badge" id="syncStatus">Offline pronto • IndexedDB</div>
          <button class="btn secondary small" id="logoutButton" type="button">Sair</button>
        </div>
      </div>

      <div class="content">
        <section class="panel">
          <div class="panel-head">
            <div>
              <h2>Medições</h2>
              <p>Selecione um equipamento vinculado para registrar uma medição.</p>
            </div>
            <a class="back" href="../index.html">Voltar para a home</a>
          </div>

          <form id="medicaoForm" class="card-form">
            <div class="form-grid">
              <div class="field">
                <label for="medicaoEquip">Equipamento *</label>
                <select id="medicaoEquip" name="equip_id" required></select>
              </div>

              <div class="field">
                <label for="medicaoTipo">Tipo de medição *</label>
                <input id="medicaoTipo" name="tipo_medicao" placeholder="RL, Qd..." required />
              </div>

              <div class="field">
                <label for="medicaoSubtipo">Subtipo *</label>
                <select id="medicaoSubtipo" name="subtipo" required>
                  <option value="">Selecione</option>
                  <option value="HORIZONTAL">Horizontal</option>
                  <option value="VERTICAL">Vertical</option>
                  <option value="TACHAS">Tachas</option>
                  <option value="LEGENDA">Legenda</option>
                  <option value="PLACA">Placa</option>
                </select>
              </div>

              <div class="field">
                <label for="medicaoClasseTipo">Classe/Tipo</label>
                <select id="medicaoClasseTipo" name="classe_tipo">
                  <option value="">Selecione</option>
                </select>
              </div>

              <div class="field">
                <label for="medicaoDataAplicacao">Data de aplicação</label>
                <input id="medicaoDataAplicacao" name="data_aplicacao" type="date" />
              </div>

              <div class="field">
                <label for="medicaoObra">Obra *</label>
                <input id="medicaoObra" name="obra_id" placeholder="OBRA-001" list="obraList" required />
                <datalist id="obraList"></datalist>
              </div>

              <div class="field">
                <label for="medicaoRelatorio">Identificador do relatório</label>
                <input id="medicaoRelatorio" name="identificadorRelatorio" placeholder="REL-2024-001" />
              </div>

              <div class="field">
                <label for="medicaoMarcacao">Elemento da via</label>
                <select id="medicaoMarcacao" name="tipoDeMarcacao">
                  <option value="">Selecione</option>
                  <option value="BORDO_DIREITO">Bordo direito</option>
                  <option value="BORDO_ESQUERDO">Bordo esquerdo</option>
                  <option value="EIXO_DIREITO">Eixo direito</option>
                  <option value="EIXO_ESQUERDO">Eixo esquerdo</option>
                  <option value="ZEBRADO">Zebrado</option>
                  <option value="CANALIZACAO">Canalização</option>
                  <option value="SETA">Seta</option>
                  <option value="LEGENDA">Legenda</option>
                </select>
              </div>

              <div class="field">
                <label for="medicaoLegendaTexto">Texto da legenda</label>
                <input id="medicaoLegendaTexto" name="texto_legenda" placeholder="Ex.: PARE" />
                <small class="muted" id="medicaoLegendaCounter">0 caractere(s)</small>
              </div>

              <div class="field">
                <label for="medicaoRodovia">Rodovia</label>
                <input id="medicaoRodovia" name="rodovia" placeholder="BR-116" />
              </div>

              <div class="field">
                <label for="medicaoKm">KM</label>
                <input id="medicaoKm" name="km" />
              </div>

              <div class="field">
                <label for="medicaoCidade">Cidade/UF</label>
                <input id="medicaoCidade" name="cidadeUF" placeholder="São Paulo-SP" />
              </div>

              <div class="field">
                <label for="medicaoEndereco">Endereço/Localidade</label>
                <input id="medicaoEndereco" name="enderecoTexto" placeholder="Pista Norte, acesso km 120" />
              </div>

              <div class="field">
                <label for="medicaoSentido">Sentido</label>
                <input id="medicaoSentido" name="sentido" />
              </div>

              <div class="field">
                <label for="medicaoFaixa">Faixa</label>
                <input id="medicaoFaixa" name="faixa" />
              </div>

              <div class="field">
                <label for="medicaoLinha">Linha</label>
                <input id="medicaoLinha" name="linha" placeholder="Bordo/Eixo" />
              </div>

              <div class="field">
                <label for="medicaoEstacao">Estação</label>
                <input id="medicaoEstacao" name="estacao" placeholder="Est. 1" />
              </div>

              <div class="field">
                <label for="medicaoLetra">Letra (compatibilidade)</label>
                <input id="medicaoLetra" name="letra" placeholder="P, A, R, E..." />
              </div>

              <div class="field">
                <label for="medicaoCor">Cor (placa)</label>
                <input id="medicaoCor" name="cor" placeholder="Branco, Vermelho..." />
              </div>

              <div class="field">
                <label for="medicaoAngulo">Ângulo (placa)</label>
                <select id="medicaoAngulo" name="angulo">
                  <option value="">Selecione</option>
                  <option value="0">0°</option>
                  <option value="90">90°</option>
                </select>
              </div>

              <div class="field">
                <label for="medicaoPosicao">Posição</label>
                <select id="medicaoPosicao" name="posicao_tipo">
                  <option value="">Selecione</option>
                  <option value="BORDO_DIREITO">Bordo Direito</option>
                  <option value="BORDO_ESQUERDO">Bordo Esquerdo</option>
                  <option value="EIXO_DIREITO">Eixo Direito</option>
                  <option value="EIXO_ESQUERDO">Eixo Esquerdo</option>
                  <option value="LEGENDA">Letra (Legenda)</option>
                </select>
              </div>

              <div class="field">
                <label for="medicaoClima">Condição climática</label>
                <input id="medicaoClima" name="clima" placeholder="Céu limpo" />
              </div>

              <div class="field">
                <label for="medicaoMedia">Média</label>
                <input id="medicaoMedia" name="media" type="number" step="0.01" readonly />
              </div>

              <div class="field field-full" id="legendaPorLetraField" style="display:none">
                <label for="legendaPorLetra">Estrutura por letra (LETRA: v1,v2,v3)</label>
                <textarea id="legendaPorLetra" rows="4" placeholder="P:120,122,121
A:118,117,119"></textarea>
              </div>

              <div class="field field-full">
                <label>Leituras *</label>
                <div class="reading-toolbar">
                  <button class="btn secondary small" id="addLeitura" type="button">+ Leitura</button>
                  <button class="btn secondary small" id="applyLeituraList" type="button">Aplicar lista colada</button>
                </div>
                <textarea id="leiturasPaste" rows="2" placeholder="Cole valores separados por ; ou linha"></textarea>
                <div class="reading-list" id="leiturasList"></div>
              </div>

              <div class="field field-full">
                <label>GPS (automático ou manual)</label>
                <div class="gps-actions">
                  <button class="btn secondary" id="captureGps" type="button">Capturar GPS automaticamente</button>
                  <span class="muted" id="gpsStatus">Sem captura.</span>
                </div>
                <div class="gps-grid">
                  <div class="field">
                    <label for="gpsLat">Latitude</label>
                    <input id="gpsLat" name="gps_lat" type="number" step="0.000001" />
                  </div>
                  <div class="field">
                    <label for="gpsLng">Longitude</label>
                    <input id="gpsLng" name="gps_lng" type="number" step="0.000001" />
                  </div>
                  <div class="field">
                    <label for="gpsAcc">Precisão (m)</label>
                    <input id="gpsAcc" name="gps_accuracy" type="number" step="0.1" />
                  </div>
                  <div class="field">
                    <label for="gpsDateTime">Data/hora GPS</label>
                    <input id="gpsDateTime" name="dataHoraGPS" type="datetime-local" />
                  </div>
                  <div class="field">
                    <label for="gpsSource">Origem</label>
                    <input id="gpsSource" name="gps_source" readonly />
                  </div>
                </div>
              </div>

              <div class="field field-full">
                <label>Fotos</label>
                <div class="photo-grid">
                  <div class="photo-field">
                    <label for="fotoMedicao">Adicionar foto da medição</label>
                    <input id="fotoMedicao" name="foto_medicao" type="file" accept="image/*" capture="environment" multiple />
                    <button class="btn secondary small" type="button" id="clearFotoMedicao">Remover fotos</button>
                    <div class="muted" id="fotoMedicaoInfo">Nenhuma foto selecionada.</div>
                  </div>
                  <div class="photo-field">
                    <label for="fotoLocal">Adicionar foto do local</label>
                    <input id="fotoLocal" name="foto_local" type="file" accept="image/*" capture="environment" multiple />
                    <button class="btn secondary small" type="button" id="clearFotoLocal">Remover fotos</button>
                    <div class="muted" id="fotoLocalInfo">Nenhuma foto selecionada.</div>
                  </div>
                </div>
              </div>

              <div class="field field-full">
                <label for="medicaoObs">Observações</label>
                <input id="medicaoObs" name="observacoes" />
              </div>
            </div>

            <div class="modal-actions">
              <span class="muted" id="medicaoHint">Campos com * são obrigatórios.</span>
              <div class="action-buttons">
                <button class="btn" type="submit">Registrar medição</button>
              </div>
            </div>
          </form>

          <div class="subpanel">
            <h3>Medições recentes</h3>
            <p class="muted">Histórico do operador logado (ou visão completa do ADMIN).</p>
            <div class="table-wrapper recent-medicoes-wrapper">
              <table class="table recent-medicoes-table" aria-label="Tabela de medições">
                <thead>
                  <tr>
                    <th>Obra</th>
                    <th>Equipamento</th>
                    <th>Subtipo</th>
                    <th>Média</th>
                    <th>Qtd Leituras</th>
                    <th>Data/Hora</th>
                  </tr>
                </thead>
                <tbody id="medicoesBody"></tbody>
              </table>
            </div>
          </div>

          <div class="subpanel">
            <h3>Relatório individual</h3>
            <p class="muted">OPERADOR: gera PDF das suas medições. ADMIN: pode gerar visão total (obra opcional) ou por filtro.</p>
            <div class="form-grid">
              <div class="field">
                <label for="userReportObra">Obra</label>
                <input id="userReportObra" placeholder="OBRA-001" list="obraList" />
              </div>
              <div class="field">
                <label for="userReportStart">Data início</label>
                <input id="userReportStart" type="date" />
              </div>
              <div class="field">
                <label for="userReportEnd">Data fim</label>
                <input id="userReportEnd" type="date" />
              </div>
            </div>
            <div class="action-buttons">
              <button class="btn" id="generateUserPdf" type="button">Gerar PDF individual</button>
              <button class="btn secondary" id="runAutoTest" type="button" hidden>Auto-Teste (ADMIN)</button>
              <button class="btn secondary" id="diagnosticoExport" type="button">Baixar Diagnóstico Completo (.json)</button>
            </div>
            <p class="muted" id="autoTestHint"></p>
          </div>
        </section>
      </div>

      <footer class="footer">
        <span id="statusMessage">Sem pendências.</span>
        <span>•</span>
        <span>Base path GitHub Pages: /medlux-control/</span>
      </footer>
    </section>
  </main>

  <div class="modal" id="loginModal" aria-hidden="true" role="dialog" aria-labelledby="loginTitle">
    <div class="modal-card">
      <header class="modal-head">
        <div>
          <h2 id="loginTitle">Login local</h2>
          <p class="muted">Somente operadores vinculados podem registrar medições.</p>
        </div>
      </header>
      <form id="loginForm" class="modal-body">
        <div class="form-grid">
          <div class="field">
            <label for="loginId">ID *</label>
            <input id="loginId" name="user_id" required />
          </div>
          <div class="field">
            <label for="loginPin">PIN *</label>
            <input id="loginPin" name="pin" type="password" inputmode="numeric" required />
          </div>
        </div>
        <div class="modal-actions">
          <span class="muted" id="loginHint">Use suas credenciais locais.</span>
          <div class="action-buttons">
            <button class="btn" type="submit">Entrar</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</body>
</html>
