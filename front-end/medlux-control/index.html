<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="app-version" content="2.0.0" />
  <title>MEDLUX Control</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="stylesheet" href="./styles.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.1/xlsx.full.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js" defer></script>
  <script type="module" src="./app.js" defer></script>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <header>
        <div class="brand">
          <h1><span class="dot"></span>MEDLUX Control</h1>
          <p>Controle offline-first de equipamentos MEDLUX com cautelas, usuários e auditoria.</p>
        </div>
        <div class="header-actions">
          <div class="badge" id="syncStatus">Offline pronto • IndexedDB</div>
          <button class="btn secondary small" id="logoutButton" type="button">Sair</button>
        </div>
      </header>

      <nav class="nav" aria-label="Abas do módulo">
        <button class="tab" type="button" data-section="dashboard" aria-selected="true">Dashboard</button>
        <button class="tab" type="button" data-section="equipamentos" aria-selected="false">Equipamentos</button>
        <button class="tab" type="button" data-section="usuarios" aria-selected="false">Usuários</button>
        <button class="tab" type="button" data-section="vinculos" aria-selected="false">Vínculos</button>
        <button class="tab" type="button" data-section="auditoria" aria-selected="false">Auditoria &amp; Backup</button>
      </nav>

      <div class="content">
        <section class="panel" data-panel="dashboard">
          <div class="panel-head">
            <div>
              <h2>Dashboard</h2>
              <p>Status geral, vínculos ativos e alertas principais.</p>
            </div>
            <a class="back" href="../index.html">Voltar para a home</a>
          </div>

          <div class="status-grid" id="statusCards"></div>

          <div class="dashboard-filters">
            <div>
              <p class="muted">Filtros rápidos por função</p>
              <div class="chip-group" id="quickTipoFilters">
                <button class="chip active" type="button" data-filter-type="">Todos</button>
                <button class="chip" type="button" data-filter-type="Horizontal">Horizontal</button>
                <button class="chip" type="button" data-filter-type="Vertical">Vertical</button>
                <button class="chip" type="button" data-filter-type="Tachas">Tachas</button>
              </div>
            </div>
            <div>
              <p class="muted">Filtros rápidos por status</p>
              <div class="chip-group" id="quickStatusFilters">
                <button class="chip active" type="button" data-filter-status="">Todos</button>
                <button class="chip" type="button" data-filter-status="Obra">Obra</button>
                <button class="chip" type="button" data-filter-status="Lab Tintas">Lab Tintas</button>
                <button class="chip" type="button" data-filter-status="Demonstração">Demonstração</button>
                <button class="chip" type="button" data-filter-status="Vendido">Vendido</button>
                <button class="chip" type="button" data-filter-status="Stand-by">Stand-by</button>
              </div>
            </div>
          </div>

          <div class="panel-split">
            <div class="subpanel">
              <h3>Vínculos ativos</h3>
              <p class="muted">Equipamentos atualmente em cautela com operadores.</p>
              <ul class="list" id="dueSoonList"></ul>
            </div>
            <div class="subpanel">
              <h3>Busca rápida</h3>
              <p class="muted">Pesquise por ID, modelo, Nº de série ou responsável.</p>
              <div class="search">
                <input type="search" id="quickSearch" placeholder="Ex: RH01, MTLX-300, 12345" />
                <button class="btn secondary" type="button" id="clearSearch">Limpar</button>
              </div>
              <div class="search-results" id="quickResults"></div>
            </div>
          </div>
        </section>

        <section class="panel" data-panel="equipamentos" hidden>
          <div class="panel-head">
            <div>
              <h2>Equipamentos</h2>
              <p>Cadastro completo com função, status e rastreabilidade.</p>
            </div>
            <div class="toolbar">
              <button class="btn" id="newEquipamento" type="button">Novo equipamento</button>
              <button class="btn secondary" id="seedEquipamentos" type="button">Carregar dados de exemplo</button>
              <button class="btn secondary" id="exportCsv" type="button">Exportar CSV da tabela</button>
            </div>
          </div>

          <div class="filters">
            <div class="filter">
              <label for="tableSearch">Busca</label>
              <input id="tableSearch" type="search" placeholder="Pesquisar por ID, modelo, série ou responsável" />
            </div>
            <div class="filter">
              <label for="typeFilter">Função</label>
              <select id="typeFilter">
                <option value="">Todos</option>
                <option value="Horizontal">Horizontal</option>
                <option value="Vertical">Vertical</option>
                <option value="Tachas">Tachas</option>
              </select>
            </div>
            <div class="filter">
              <label for="statusFilter">Status</label>
              <select id="statusFilter">
                <option value="">Todos</option>
                <option value="Obra">Obra</option>
                <option value="Lab Tintas">Lab Tintas</option>
                <option value="Demonstração">Demonstração</option>
                <option value="Vendido">Vendido</option>
                <option value="Stand-by">Stand-by</option>
              </select>
            </div>
            <div class="filter">
              <label for="pageSize">Mostrar</label>
              <select id="pageSize">
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="table" aria-label="Tabela de equipamentos">
              <thead>
                <tr>
                  <th><button class="sort-btn" type="button" data-sort="id">ID</button></th>
                  <th><button class="sort-btn" type="button" data-sort="funcao">Função</button></th>
                  <th><button class="sort-btn" type="button" data-sort="modelo">Modelo</button></th>
                  <th><button class="sort-btn" type="button" data-sort="numeroSerie">Nº Série</button></th>
                  <th><button class="sort-btn" type="button" data-sort="usuarioResponsavel">Responsável</button></th>
                  <th>Status</th>
                  <th>Localidade</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="equipamentosBody"></tbody>
            </table>
          </div>

          <div class="pagination">
            <button class="btn secondary" id="prevPage" type="button">Anterior</button>
            <span class="muted" id="pageInfo">Página 1</span>
            <button class="btn secondary" id="nextPage" type="button">Próxima</button>
          </div>
        </section>

        <section class="panel" data-panel="usuarios" hidden>
          <div class="panel-head">
            <div>
              <h2>Usuários</h2>
              <p>Cadastro local com autenticação offline por PIN.</p>
            </div>
            <div class="toolbar">
              <button class="btn" id="newUsuario" type="button">Novo usuário</button>
            </div>
          </div>
          <div class="table-wrapper">
            <table class="table" aria-label="Tabela de usuários">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nome</th>
                  <th>Perfil</th>
                  <th>Status</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="usuariosBody"></tbody>
            </table>
          </div>
        </section>

        <section class="panel" data-panel="vinculos" hidden>
          <div class="panel-head">
            <div>
              <h2>Vínculos / Cautelas</h2>
              <p>Relaciona equipamentos a usuários com termo de cautela.</p>
            </div>
            <div class="toolbar">
              <button class="btn" id="newVinculo" type="button">Novo vínculo</button>
            </div>
          </div>
          <div class="table-wrapper">
            <table class="table" aria-label="Tabela de vínculos">
              <thead>
                <tr>
                  <th>Equipamento</th>
                  <th>Usuário</th>
                  <th>Início</th>
                  <th>Status</th>
                  <th>Termo</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="vinculosBody"></tbody>
            </table>
          </div>
        </section>

        <section class="panel" data-panel="auditoria" hidden>
          <div class="panel-head">
            <div>
              <h2>Auditoria &amp; Backup</h2>
              <p>Exportação, importação e limpeza total do armazenamento local.</p>
            </div>
          </div>

          <div class="audit-grid">
            <div class="subpanel">
              <h3>Relatório de auditoria</h3>
              <p class="muted">Gera um PDF completo com resumo, vínculos e medições.</p>
              <button class="btn" id="generateAuditPdf" type="button">Gerar PDF de Auditoria</button>
            </div>
            <div class="subpanel">
              <h3>Exportar backup</h3>
              <p class="muted">Gera um arquivo JSON com todos os dados locais.</p>
              <button class="btn" id="exportBackup" type="button">Exportar JSON</button>
            </div>
            <div class="subpanel">
              <h3>Importar JSON</h3>
              <p class="muted">Valida e permite mesclar ou substituir todos os dados.</p>
              <input type="file" id="importFile" accept="application/json" />
              <div class="radio-group">
                <label><input type="radio" name="importMode" value="merge" checked /> Mesclar</label>
                <label><input type="radio" name="importMode" value="replace" /> Substituir tudo</label>
              </div>
              <button class="btn secondary" id="importBackup" type="button">Importar JSON</button>
            </div>
            <div class="subpanel">
              <h3>Importar Excel (.xlsx)</h3>
              <p class="muted">Faça a pré-visualização antes de importar para o IndexedDB.</p>
              <input type="file" id="importXlsxFile" accept=".xlsx" />
              <div class="radio-group">
                <label><input type="radio" name="importXlsxMode" value="merge" checked /> Mesclar (atualiza campos existentes)</label>
                <label><input type="radio" name="importXlsxMode" value="replace" /> Substituir tudo</label>
              </div>
              <div class="toolbar">
                <button class="btn secondary" id="previewXlsx" type="button">Pré-visualizar Excel</button>
                <button class="btn" id="importXlsx" type="button">Importar Excel (.xlsx)</button>
              </div>
              <div class="preview-card" id="xlsxPreview"></div>
            </div>
            <div class="subpanel">
              <h3>Importação em lote</h3>
              <p class="muted">Cole aqui dados do Excel (TSV) ou CSV com os cabeçalhos padrão.</p>
              <textarea id="bulkPaste" rows="7" placeholder="Identificação | Função | Nº de série | Data de aquisição | Fabricante | Localidade"></textarea>
              <div class="toolbar">
                <button class="btn secondary" id="importBulk" type="button">Importar texto colado</button>
                <a class="download-link" href="./seed.csv" download>Baixar CSV de exemplo</a>
              </div>
            </div>
            <div class="subpanel">
              <h3>Importar CSV</h3>
              <p class="muted">Aceita cabeçalhos semelhantes ao padrão da planilha.</p>
              <input type="file" id="importCsvFile" accept="text/csv" />
              <button class="btn secondary" id="importCsv" type="button">Importar CSV</button>
            </div>
            <div class="subpanel">
              <h3>Resetar dados locais</h3>
              <p class="muted">Remove todo o conteúdo salvo no IndexedDB.</p>
              <button class="btn danger" id="resetData" type="button">Resetar IndexedDB</button>
            </div>
          </div>
        </section>
      </div>

      <footer class="footer">
        <span id="statusMessage">Sem pendências.</span>
        <span>•</span>
        <span>Base path GitHub Pages: /medlux-control/</span>
      </footer>
    </section>
  </main>

  <div class="modal" id="equipamentoModal" aria-hidden="true" role="dialog" aria-labelledby="modalTitle">
    <div class="modal-card">
      <header class="modal-head">
        <div>
          <h2 id="modalTitle">Novo equipamento</h2>
          <p class="muted">Preencha os campos obrigatórios para salvar.</p>
        </div>
        <button class="icon-btn" type="button" id="closeModal" aria-label="Fechar">×</button>
      </header>
      <form id="equipamentoForm" class="modal-body">
        <div class="form-grid">
          <div class="field">
            <label for="equipId">Identificação *</label>
            <input id="equipId" name="id" required maxlength="20" />
          </div>
          <div class="field">
            <label for="equipFuncao">Função *</label>
            <select id="equipFuncao" name="funcao" required>
              <option value="">Selecione</option>
              <option value="Horizontal">Horizontal</option>
              <option value="Vertical">Vertical</option>
              <option value="Tachas">Tachas</option>
            </select>
          </div>
          <div class="field">
            <label for="equipGeometria">Geometria</label>
            <select id="equipGeometria" name="geometria">
              <option value="">Não aplicável</option>
              <option value="15m">15m</option>
              <option value="30m">30m</option>
            </select>
          </div>
          <div class="field">
            <label for="equipSerie">Nº de série</label>
            <input id="equipSerie" name="numeroSerie" />
          </div>
          <div class="field">
            <label for="equipModelo">Modelo</label>
            <input id="equipModelo" name="modelo" />
          </div>
          <div class="field">
            <label for="equipAquisicao">Data de aquisição</label>
            <input id="equipAquisicao" name="dataAquisicao" type="date" />
          </div>
          <div class="field">
            <label for="equipFabricante">Fabricante</label>
            <input id="equipFabricante" name="fabricante" />
          </div>
          <div class="field">
            <label for="equipCertificado">Nº Certificado</label>
            <input id="equipCertificado" name="numeroCertificado" />
          </div>
          <div class="field">
            <label for="equipStatus">Status</label>
            <select id="equipStatus" name="status">
              <option value="Obra">Obra</option>
              <option value="Lab Tintas">Lab Tintas</option>
              <option value="Demonstração">Demonstração</option>
              <option value="Vendido">Vendido</option>
              <option value="Stand-by">Stand-by</option>
            </select>
          </div>
          <div class="field">
            <label for="equipCalibrado">Calibrado</label>
            <select id="equipCalibrado" name="calibrado">
              <option value="true">Sim</option>
              <option value="false">Não</option>
            </select>
          </div>
          <div class="field">
            <label for="equipResponsavel">Responsável atual</label>
            <input id="equipResponsavel" name="usuarioResponsavel" />
          </div>
          <div class="field">
            <label for="equipLocalidade">Localidade (Cidade/UF)</label>
            <input id="equipLocalidade" name="localidade" placeholder="Cidade-UF" />
          </div>
          <div class="field">
            <label for="equipEntrega">Data entrega usuário</label>
            <input id="equipEntrega" name="dataEntregaUsuario" type="date" />
          </div>
          <div class="field field-full">
            <label for="equipObs">Observações</label>
            <textarea id="equipObs" name="observacoes" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <span class="muted" id="formHint">Campos com * são obrigatórios.</span>
          <div class="action-buttons">
            <button class="btn danger" type="button" id="deleteEquipamento">Excluir</button>
            <button class="btn secondary" type="button" id="cancelModal">Cancelar</button>
            <button class="btn" type="submit">Salvar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="usuarioModal" aria-hidden="true" role="dialog" aria-labelledby="usuarioTitle">
    <div class="modal-card">
      <header class="modal-head">
        <div>
          <h2 id="usuarioTitle">Novo usuário</h2>
          <p class="muted">Defina o ID, nome e perfil. O PIN é obrigatório.</p>
        </div>
        <button class="icon-btn" type="button" id="closeUsuario" aria-label="Fechar">×</button>
      </header>
      <form id="usuarioForm" class="modal-body">
        <div class="form-grid">
          <div class="field">
            <label for="usuarioId">ID *</label>
            <input id="usuarioId" name="user_id" required maxlength="20" />
          </div>
          <div class="field">
            <label for="usuarioNome">Nome *</label>
            <input id="usuarioNome" name="nome" required />
          </div>
          <div class="field">
            <label for="usuarioRole">Perfil *</label>
            <select id="usuarioRole" name="role" required>
              <option value="ADMIN">ADMIN</option>
              <option value="OPERADOR">OPERADOR</option>
            </select>
          </div>
          <div class="field">
            <label for="usuarioPin">PIN *</label>
            <input id="usuarioPin" name="pin" type="password" inputmode="numeric" required />
          </div>
          <div class="field">
            <label for="usuarioAtivo">Ativo</label>
            <select id="usuarioAtivo" name="ativo">
              <option value="true">Sim</option>
              <option value="false">Não</option>
            </select>
          </div>
        </div>
        <div class="modal-actions">
          <span class="muted" id="usuarioHint">Campos com * são obrigatórios.</span>
          <div class="action-buttons">
            <button class="btn secondary" type="button" id="cancelUsuario">Cancelar</button>
            <button class="btn" type="submit">Salvar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="vinculoModal" aria-hidden="true" role="dialog" aria-labelledby="vinculoTitle">
    <div class="modal-card">
      <header class="modal-head">
        <div>
          <h2 id="vinculoTitle">Novo vínculo</h2>
          <p class="muted">Vincule um equipamento a um usuário e anexe o termo.</p>
        </div>
        <button class="icon-btn" type="button" id="closeVinculo" aria-label="Fechar">×</button>
      </header>
      <form id="vinculoForm" class="modal-body">
        <div class="form-grid">
          <div class="field">
            <label for="vinculoEquip">Equipamento *</label>
            <select id="vinculoEquip" name="equip_id" required></select>
          </div>
          <div class="field">
            <label for="vinculoUser">Usuário *</label>
            <select id="vinculoUser" name="user_id" required></select>
          </div>
          <div class="field">
            <label for="vinculoInicio">Data início *</label>
            <input id="vinculoInicio" name="data_inicio" type="date" required />
          </div>
          <div class="field">
            <label for="vinculoTermo">Termo cautela (PDF)</label>
            <input id="vinculoTermo" name="termo" type="file" accept="application/pdf" />
          </div>
        </div>
        <div class="modal-actions">
          <span class="muted" id="vinculoHint">Campos com * são obrigatórios.</span>
          <div class="action-buttons">
            <button class="btn secondary" type="button" id="cancelVinculo">Cancelar</button>
            <button class="btn" type="submit">Salvar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="loginModal" aria-hidden="true" role="dialog" aria-labelledby="loginTitle">
    <div class="modal-card">
      <header class="modal-head">
        <div>
          <h2 id="loginTitle">Login local</h2>
          <p class="muted">Informe ID e PIN para acessar o MEDLUX Control.</p>
        </div>
      </header>
      <form id="loginForm" class="modal-body">
        <div class="form-grid">
          <div class="field">
            <label for="loginId">ID *</label>
            <input id="loginId" name="user_id" required />
          </div>
          <div class="field">
            <label for="loginPin">PIN *</label>
            <input id="loginPin" name="pin" type="password" inputmode="numeric" required />
          </div>
        </div>
        <div class="modal-actions">
          <span class="muted" id="loginHint">Use o usuário ADMIN e PIN 1234 no primeiro acesso.</span>
          <div class="action-buttons">
            <button class="btn" type="submit">Entrar</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</body>
</html>
